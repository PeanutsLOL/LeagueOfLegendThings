using System;
using Microsoft.Xna.Framework;
using Terraria;
using Terraria.ModLoader;
using Terraria.ID;
using Terraria.Audio;
using LeagueOfLegendThings.Content.Systems;

namespace LeagueOfLegendThings.Content.Buffs
{
    // Press the Attack (强攻) 逻辑：3 次命中后造成额外伤害并给予伤害加成
    public class PressTheAttackPlayer : ModPlayer
    {
        private const int ProcDamageBuffDuration = 6 * 60; // 6 秒
        private const int ProcCooldown = 5 * 60; // 5 秒冷却（buff 结束后开始）

        private int hitCount;
        private int accumulatedDamage;
        private int buffTimer;
        private int cooldownTimer;

        public override void OnHitNPCWithItem(Item item, NPC target, NPC.HitInfo hit, int damageDone)
        {
            HandlePressTheAttack(target, damageDone);
        }

        public override void OnHitNPCWithProj(Projectile proj, NPC target, NPC.HitInfo hit, int damageDone)
        {
            // 自身投射物命中也计数（如需排除特定弹幕，可在此过滤）
            HandlePressTheAttack(target, damageDone);
        }

        public override void PostUpdateMiscEffects()
        {
            bool hadBuff = buffTimer > 0;

            if (buffTimer > 0)
            {
                buffTimer--;
                Player.GetDamage(DamageClass.Generic) += 0.08f;
            }

            if (cooldownTimer > 0)
            {
                cooldownTimer--;
            }

            if (buffTimer <= 0 && hadBuff)
            {
                cooldownTimer = ProcCooldown;
                // 结束后重置计数
                hitCount = 0;
                accumulatedDamage = 0;
            }
        }

        public override void UpdateDead()
        {
            hitCount = 0;
            accumulatedDamage = 0;
            buffTimer = 0;
            cooldownTimer = 0;
        }

        private void HandlePressTheAttack(NPC target, int damageDone)
        {
            var runeSave = ModContent.GetInstance<RuneSaveSystem>();
            if (!runeSave.PressTheAttackSelected)
                return;

            if (target.friendly || target.lifeMax <= 5)
                return;

            // 如果 buff 正在持续，命中刷新持续时间
            if (buffTimer > 0)
            {
                buffTimer = ProcDamageBuffDuration;
                return;
            }

            // 冷却中，不计数
            if (cooldownTimer > 0)
                return;

            hitCount++;
            accumulatedDamage += Math.Max(0, damageDone);

            if (hitCount >= 3)
            {
                int denom = Player.statLifeMax2 + Player.statManaMax2;
                float scale = denom > 0 ? (accumulatedDamage * 0.5f) / denom * 700f : 0f;
                int bonusDamage = Math.Max(1, (int)MathF.Round(40f + scale));

                // 对当前目标追加一次伤害
                target.SimpleStrikeNPC(bonusDamage, Player.direction, crit: false, knockBack: 0f, damageType: DamageClass.Generic);
                CombatText.NewText(target.Hitbox, Color.Orange, $"PTA +{bonusDamage}");
                if (Main.netMode != NetmodeID.SinglePlayer)
                {
                    NetMessage.SendData(MessageID.SyncNPC, number: target.whoAmI);
                }

                // 随机播放两段音效之一
                var sfx = new SoundStyle(Main.rand.NextBool()
                    ? "LeagueOfLegendThings/Content/Buffs/Press_the_Attack_SFX"
                    : "LeagueOfLegendThings/Content/Buffs/Press_the_Attack_SFX_2")
                {
                    Volume = 0.75f,
                    PitchVariance = 0f
                };
                SoundEngine.PlaySound(sfx, Player.Center);

                // 开启 buff，重置计数
                buffTimer = ProcDamageBuffDuration;
                hitCount = 0;
                accumulatedDamage = 0;
            }
        }
    }
}
