using System;
using Terraria;
using Terraria.ModLoader;
using Terraria.ID;
using LeagueOfLegendThings.Content.Systems;

namespace LeagueOfLegendThings.Content.Buffs
{
    // Press the Attack (强攻) 逻辑：3 次命中后造成额外伤害并给予伤害加成
    public class PressTheAttackPlayer : ModPlayer
    {
        private const int ProcDamageBuffDuration = 6 * 60; // 6 秒

        private int hitCount;
        private int accumulatedDamage;
        private int buffTimer;

        public override void OnHitNPCWithItem(Item item, NPC target, NPC.HitInfo hit, int damageDone)
        {
            HandlePressTheAttack(target, damageDone);
        }

        public override void OnHitNPCWithProj(Projectile proj, NPC target, NPC.HitInfo hit, int damageDone)
        {
            // 自身投射物命中也计数（如需排除特定弹幕，可在此过滤）
            HandlePressTheAttack(target, damageDone);
        }

        public override void PostUpdateMiscEffects()
        {
            if (buffTimer > 0)
            {
                buffTimer--;
                Player.GetDamage(DamageClass.Generic) += 0.08f;
            }
        }

        public override void UpdateDead()
        {
            hitCount = 0;
            accumulatedDamage = 0;
            buffTimer = 0;
        }

        private void HandlePressTheAttack(NPC target, int damageDone)
        {
            var runeSave = ModContent.GetInstance<RuneSaveSystem>();
            if (!runeSave.PressTheAttackSelected)
                return;

            if (target.friendly || target.lifeMax <= 5)
                return;

            hitCount++;
            accumulatedDamage += Math.Max(0, damageDone);

            if (hitCount >= 3)
            {
                int denom = Player.statLifeMax2 + Player.statManaMax2;
                float scale = denom > 0 ? (accumulatedDamage * 0.05f) / denom * 700f : 0f;
                int bonusDamage = Math.Max(1, (int)MathF.Round(40f + scale));

                // 对当前目标追加一次伤害
                target.SimpleStrikeNPC(bonusDamage, Player.direction, crit: false, knockBack: 0f, damageType: DamageClass.Generic);
                if (Main.netMode != NetmodeID.SinglePlayer)
                {
                    NetMessage.SendData(MessageID.SyncNPC, number: target.whoAmI);
                }

                // 给予自身 8% 全伤加成一段时间
                buffTimer = ProcDamageBuffDuration;

                // 重置计数
                hitCount = 0;
                accumulatedDamage = 0;
            }
        }
    }
}
